<!doctype html>
<html lang="ja" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å±±ä»²é–“å‹Ÿé›† - Hiking Connect</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0284c7">
  <link rel="apple-touch-icon" href="icon.svg">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&amp;display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans JP', sans-serif; background-color: #f0f9ff; }
    .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
    .scroll-container::-webkit-scrollbar { width: 6px; }
    .scroll-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .filter-chip { padding: 6px 14px; border-radius: 20px; cursor: pointer; transition: all 0.2s; border: 2px solid; font-weight: 500; font-size: 0.875rem; }
  </style>
 </head>
 <body class="h-full text-slate-800">
  <div id="app" class="max-w-4xl mx-auto min-h-screen flex flex-col"></div>

  <script>
    // --- 1. ãƒ‡ãƒ¼ã‚¿ã¨å®šæ•° ---
    const STORAGE_KEY = 'hiking_app_v5_data';
    const PREFECTURES = ["åŒ—æµ·é“","é’æ£®çœŒ","å²©æ‰‹çœŒ","å®®åŸçœŒ","ç§‹ç”°çœŒ","å±±å½¢çœŒ","ç¦å³¶çœŒ","èŒ¨åŸçœŒ","æ ƒæœ¨çœŒ","ç¾¤é¦¬çœŒ","åŸ¼ç‰çœŒ","åƒè‘‰çœŒ","æ±äº¬éƒ½","ç¥å¥ˆå·çœŒ","æ–°æ½ŸçœŒ","å¯Œå±±çœŒ","çŸ³å·çœŒ","ç¦äº•çœŒ","å±±æ¢¨çœŒ","é•·é‡çœŒ","å²é˜œçœŒ","é™å²¡çœŒ","æ„›çŸ¥çœŒ","ä¸‰é‡çœŒ","æ»‹è³€çœŒ","äº¬éƒ½åºœ","å¤§é˜ªåºœ","å…µåº«çœŒ","å¥ˆè‰¯çœŒ","å’Œæ­Œå±±çœŒ","é³¥å–çœŒ","å³¶æ ¹çœŒ","å²¡å±±çœŒ","åºƒå³¶çœŒ","å±±å£çœŒ","å¾³å³¶çœŒ","é¦™å·çœŒ","æ„›åª›çœŒ","é«˜çŸ¥çœŒ","ç¦å²¡çœŒ","ä½è³€çœŒ","é•·å´çœŒ","ç†Šæœ¬çœŒ","å¤§åˆ†çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ","æ²–ç¸„çœŒ"];

    let allData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    let currentView = 'list';
    let currentPostId = null;

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹
    let selectedStatuses = new Set(['open', 'closed']); 
    let selectedDifficulties = new Set(['åˆå¿ƒè€…å‘ã‘', 'ä¸­ç´šè€…å‘ã‘', 'ä¸Šç´šè€…å‘ã‘']);
    let filterPrefecture = "ã™ã¹ã¦";

    // --- 2. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
      renderApp();
    }

    function calculateStatus(deadline) {
      return new Date() > new Date(deadline) ? 'closed' : 'open';
    }

    function formatDateTime(dtStr) {
      if(!dtStr) return "-";
      const dt = new Date(dtStr);
      return `${dt.getMonth() + 1}æœˆ${dt.getDate()}æ—¥ ${dt.getHours()}æ™‚`;
    }

    // --- 3. ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© ---
    window.deletePost = (e, id) => {
      e.stopPropagation();
      const post = allData.find(i => i.id === id);
      const pass = prompt('å‰Šé™¤ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›:');
      if (pass === post.password) {
        allData = allData.filter(i => i.id !== id && i.postId !== id);
        saveData();
      } else if (pass !== null) alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
    };

    function toggleFilter(set, val) {
      set.has(val) ? set.delete(val) : set.add(val);
      renderApp();
    }

    // --- 4. ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ---
    function renderApp() {
      const app = document.getElementById('app');
      if (currentView === 'list') app.innerHTML = renderListView();
      else if (currentView === 'create') app.innerHTML = renderCreateView();
      else if (currentView === 'chat') app.innerHTML = renderChatView();
      window.scrollTo(0, 0);
    }

    function renderListView() {
      let posts = allData.filter(i => i.type === 'post').filter(p => {
        const status = calculateStatus(p.deadline);
        const matchStatus = selectedStatuses.has(status);
        const matchDiff = selectedDifficulties.has(p.difficulty);
        const matchPref = (filterPrefecture === "ã™ã¹ã¦" || p.prefecture === filterPrefecture);
        return matchStatus && matchDiff && matchPref;
      }).reverse();

      return `
        <header class="flex justify-between items-center p-6">
          <h1 class="text-2xl font-bold">ğŸ”ï¸ å±±ä»²é–“å‹Ÿé›†</h1>
          <button onclick="currentView='create'; renderApp()" class="bg-[#0081c9] text-white px-4 py-2 rounded-lg font-bold shadow-md">å‹Ÿé›†ä½œæˆ</button>
        </header>

        <main class="px-6 flex-grow">
          <div class="bg-white rounded-xl p-6 mb-8 card-shadow border border-slate-100 space-y-6">
            <h3 class="font-bold text-slate-800 flex items-center gap-2">ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-4">
                <div>
                  <p class="text-[10px] font-bold text-slate-400 mb-2 uppercase">å‹Ÿé›†çŠ¶æ…‹</p>
                  <div class="flex gap-2">
                    ${[['open','ğŸŸ¢ å‹Ÿé›†ä¸­'], ['closed','ğŸŸ¡ ç· åˆ‡']].map(([v, l]) => {
                      const active = selectedStatuses.has(v);
                      return `<span onclick="toggleFilter(selectedStatuses, '${v}')" class="filter-chip" style="background:${active ? '#0284c7' : 'transparent'}; color:${active ? '#fff' : '#64748b'}; border-color:${active ? '#0284c7' : '#e2e8f0'}">${l}</span>`;
                    }).join('')}
                  </div>
                </div>
                <div>
                  <p class="text-[10px] font-bold text-slate-400 mb-2 uppercase">é›£æ˜“åº¦</p>
                  <div class="flex flex-wrap gap-2">
                    ${['åˆå¿ƒè€…å‘ã‘', 'ä¸­ç´šè€…å‘ã‘', 'ä¸Šç´šè€…å‘ã‘'].map(d => {
                      const active = selectedDifficulties.has(d);
                      return `<span onclick="toggleFilter(selectedDifficulties, '${d}')" class="filter-chip" style="background:${active ? '#0284c7' : 'transparent'}; color:${active ? '#fff' : '#64748b'}; border-color:${active ? '#0284c7' : '#e2e8f0'}">${d}</span>`;
                    }).join('')}
                  </div>
                </div>
              </div>
              <div>
                <p class="text-[10px] font-bold text-slate-400 mb-2 uppercase">æ‰€åœ¨åœ°</p>
                <select onchange="filterPrefecture=this.value; renderApp()" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg outline-none">
                  <option value="ã™ã¹ã¦">ã™ã¹ã¦è¡¨ç¤º</option>
                  ${PREFECTURES.map(p => `<option value="${p}" ${filterPrefecture===p?'selected':''}>${p}</option>`).join('')}
                </select>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-10">
            ${posts.length === 0 ? '<p class="text-center text-slate-400 col-span-2 py-10">è©²å½“ã™ã‚‹å‹Ÿé›†ã¯ã‚ã‚Šã¾ã›ã‚“</p>' : 
              posts.map(post => `
                <div class="bg-white rounded-2xl p-6 card-shadow cursor-pointer relative" onclick="openChat('${post.id}')">
                  <div class="absolute top-4 right-4 flex flex-col items-end gap-1">
                    <span class="bg-emerald-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">${calculateStatus(post.deadline)==='open'?'å‹Ÿé›†ä¸­':'ç· åˆ‡'}</span>
                    <button onclick="deletePost(event, '${post.id}')" class="mt-2 text-slate-300 hover:text-red-500 text-xs">ğŸ—‘ï¸ å‰Šé™¤</button>
                  </div>
                  <h3 class="text-xl font-bold mb-4 pr-16">${post.title}</h3>
                  <div class="space-y-1 text-sm text-slate-600 mb-4">
                    <p>â›°ï¸ <strong>${post.mountain} (${post.prefecture})</strong></p>
                    <p>ğŸ“… ç™»å±±: <span class="text-blue-600 font-bold">${formatDateTime(post.startDateTime)}</span></p>
                    <p>ğŸ ä¸‹å±±: ${formatDateTime(post.endDateTime)}</p>
                    <p>ğŸ‘¥ é›£æ˜“åº¦: ${post.difficulty}</p>
                  </div>
                  <div class="pt-4 border-t flex justify-between items-center text-xs text-slate-400">
                    <span>æŠ•ç¨¿è€…: ${post.author}</span>
                    <span class="text-blue-500 font-bold">ğŸ’¬ ${allData.filter(i => i.postId === post.id).length} ä»¶</span>
                  </div>
                </div>
              `).join('')}
          </div>
        </main>
      `;
    }

    function renderCreateView() {
      return `
        <div class="p-6">
          <h2 class="text-2xl font-bold mb-6">å‹Ÿé›†ã‚’ä½œæˆ</h2>
          <form id="createForm" class="bg-white p-8 rounded-2xl card-shadow space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <input type="text" id="author" placeholder="ãŠåå‰" required class="p-3 border rounded-lg">
              <input type="password" id="password" placeholder="å‰Šé™¤ãƒ‘ã‚¹" required class="p-3 border border-red-100 bg-red-50 rounded-lg">
            </div>
            <input type="text" id="title" placeholder="å‹Ÿé›†ã‚¿ã‚¤ãƒˆãƒ«" required class="w-full p-3 border rounded-lg">
            <div class="grid grid-cols-2 gap-4">
              <input type="text" id="mountain" placeholder="å±±ã®åå‰" required class="p-3 border rounded-lg">
              <select id="prefecture" class="p-3 border rounded-lg">
                ${PREFECTURES.map(p => `<option value="${p}">${p}</option>`).join('')}
              </select>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div><label class="text-[10px] font-bold block">ç™»å±±æ—¥æ™‚</label><input type="datetime-local" id="startDateTime" required class="w-full p-3 border rounded-lg"></div>
              <div><label class="text-[10px] font-bold block">ä¸‹å±±æ—¥æ™‚</label><input type="datetime-local" id="endDateTime" required class="w-full p-3 border rounded-lg"></div>
            </div>
            <div><label class="text-[10px] font-bold block">å‹Ÿé›†ç· åˆ‡æ—¥</label><input type="date" id="deadline" required class="w-full p-3 border rounded-lg"></div>
            <div class="grid grid-cols-2 gap-4">
              <select id="difficulty" class="p-3 border rounded-lg">
                <option>åˆå¿ƒè€…å‘ã‘</option><option>ä¸­ç´šè€…å‘ã‘</option><option>ä¸Šç´šè€…å‘ã‘</option>
              </select>
              <select id="members" class="p-3 border rounded-lg">
                <option>1äºº</option><option>2äºº</option><option>3äººä»¥ä¸Š</option>
              </select>
            </div>
            <textarea id="description" rows="4" placeholder="è©³ç´°èª¬æ˜ï¼ˆé›†åˆå ´æ‰€ãªã©ï¼‰" class="w-full p-3 border rounded-lg"></textarea>
            <div class="flex gap-4">
              <button type="submit" class="flex-grow bg-[#0081c9] text-white py-4 rounded-xl font-bold">æŠ•ç¨¿ã™ã‚‹</button>
              <button type="button" onclick="currentView='list'; renderApp()" class="px-6 border rounded-xl">æˆ»ã‚‹</button>
            </div>
          </form>
        </div>
      `;
    }

    function renderChatView() {
      const post = allData.find(i => i.id === currentPostId);
      const messages = allData.filter(i => i.postId === currentPostId && i.type === 'chat');
      return `
        <header class="p-6 flex items-center gap-4 bg-white border-b">
          <button onclick="currentView='list'; renderApp()" class="text-xl">â†</button>
          <h2 class="font-bold truncate">${post.title}</h2>
        </header>
        <div class="flex-grow p-6 overflow-y-auto space-y-4">
          <div class="bg-white p-4 rounded-xl border border-blue-100 text-sm whitespace-pre-wrap">${post.description || "è©³ç´°ãªã—"}</div>
          ${messages.map(m => `<div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 max-w-[90%]"><p class="text-[10px] text-slate-400">ğŸ‘¤ ${m.user}</p><p class="text-sm">${m.text}</p></div>`).join('')}
        </div>
        <div class="p-4 bg-white border-t flex gap-2">
          <input type="text" id="msgInput" class="flex-grow p-3 bg-slate-100 rounded-xl" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸...">
          <button onclick="sendChat()" class="bg-[#0081c9] text-white px-6 rounded-xl font-bold">é€ä¿¡</button>
        </div>
      `;
    }

    // --- 5. åˆæœŸåŒ– ---
    document.addEventListener('submit', (e) => {
      if (e.target.id === 'createForm') {
        e.preventDefault();
        allData.push({
          type: 'post', id: 'p' + Date.now(),
          author: document.getElementById('author').value,
          password: document.getElementById('password').value,
          title: document.getElementById('title').value,
          mountain: document.getElementById('mountain').value,
          prefecture: document.getElementById('prefecture').value,
          startDateTime: document.getElementById('startDateTime').value,
          endDateTime: document.getElementById('endDateTime').value,
          deadline: document.getElementById('deadline').value,
          difficulty: document.getElementById('difficulty').value,
          description: document.getElementById('description').value
        });
        saveData();
        currentView = 'list';
      }
    });

    window.sendChat = () => {
      const input = document.getElementById('msgInput');
      if (!input.value) return;
      allData.push({ type: 'chat', postId: currentPostId, user: 'ã‚²ã‚¹ãƒˆ', text: input.value });
      input.value = '';
      saveData();
    };

    window.openChat = (id) => { currentPostId = id; currentView = 'chat'; renderApp(); };

    renderApp();
  </script>
 </body>
</html>
