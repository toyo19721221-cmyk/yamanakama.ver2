<!doctype html>
<html lang="ja" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å±±ä»²é–“å‹Ÿé›† - Hiking Connect</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0284c7">
  <link rel="apple-touch-icon" href="icon.svg">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&amp;display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans JP', sans-serif; background-color: #f0f9ff; }
    .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
    .scroll-container::-webkit-scrollbar { width: 6px; }
    .scroll-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .filter-chip { padding: 6px 14px; border-radius: 20px; cursor: pointer; transition: all 0.2s; border: 2px solid; font-weight: 500; font-size: 0.875rem; }
  </style>
 </head>
 <body class="h-full text-slate-800">
  <div id="app" class="max-w-4xl mx-auto min-h-screen flex flex-col"></div>

  <script>
    // --- ãƒ‡ãƒ¼ã‚¿ã¨è¨­å®š ---
    const STORAGE_KEY = 'hiking_app_v4_data';
    const PREFECTURES = ["åŒ—æµ·é“","é’æ£®çœŒ","å²©æ‰‹çœŒ","å®®åŸçœŒ","ç§‹ç”°çœŒ","å±±å½¢çœŒ","ç¦å³¶çœŒ","èŒ¨åŸçœŒ","æ ƒæœ¨çœŒ","ç¾¤é¦¬çœŒ","åŸ¼ç‰çœŒ","åƒè‘‰çœŒ","æ±äº¬éƒ½","ç¥å¥ˆå·çœŒ","æ–°æ½ŸçœŒ","å¯Œå±±çœŒ","çŸ³å·çœŒ","ç¦äº•çœŒ","å±±æ¢¨çœŒ","é•·é‡çœŒ","å²é˜œçœŒ","é™å²¡çœŒ","æ„›çŸ¥çœŒ","ä¸‰é‡çœŒ","æ»‹è³€çœŒ","äº¬éƒ½åºœ","å¤§é˜ªåºœ","å…µåº«çœŒ","å¥ˆè‰¯çœŒ","å’Œæ­Œå±±çœŒ","é³¥å–çœŒ","å³¶æ ¹çœŒ","å²¡å±±çœŒ","åºƒå³¶çœŒ","å±±å£çœŒ","å¾³å³¶çœŒ","é¦™å·çœŒ","æ„›åª›çœŒ","é«˜çŸ¥çœŒ","ç¦å²¡çœŒ","ä½è³€çœŒ","é•·å´çœŒ","ç†Šæœ¬çœŒ","å¤§åˆ†çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ","æ²–ç¸„çœŒ"];

    let allData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    let currentView = 'list';
    let currentPostId = null;

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹
    let selectedDifficulties = new Set(['åˆå¿ƒè€…å‘ã‘', 'ä¸­ç´šè€…å‘ã‘', 'ä¸Šç´šè€…å‘ã‘']);
    let selectedPrefecture = "ã™ã¹ã¦";

    // ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ç™»éŒ²
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      });
    }

    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
      renderApp();
    }

    function formatDateTime(dtStr) {
      if(!dtStr) return "-";
      const dt = new Date(dtStr);
      return `${dt.getMonth() + 1}æœˆ${dt.getDate()}æ—¥ ${dt.getHours()}æ™‚`;
    }

    window.deletePost = (e, id) => {
      e.stopPropagation();
      const post = allData.find(i => i.id === id);
      const inputPass = prompt('å‰Šé™¤ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (inputPass === post.password) {
        allData = allData.filter(i => i.id !== id && i.postId !== id);
        saveData();
      } else if (inputPass !== null) {
        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
      }
    };

    function toggleDifficulty(diff) {
      selectedDifficulties.has(diff) ? selectedDifficulties.delete(diff) : selectedDifficulties.add(diff);
      renderApp();
    }

    // --- ãƒ¡ã‚¤ãƒ³è¡¨ç¤º ---
    function renderApp() {
      const app = document.getElementById('app');
      if (currentView === 'list') app.innerHTML = renderListView();
      else if (currentView === 'create') app.innerHTML = renderCreateView();
      else if (currentView === 'chat') app.innerHTML = renderChatView();
      window.scrollTo(0, 0);
    }

    function renderListView() {
      let posts = allData.filter(i => i.type === 'post');
      
      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
      if (selectedPrefecture !== "ã™ã¹ã¦") posts = posts.filter(p => p.prefecture === selectedPrefecture);
      posts = posts.filter(p => selectedDifficulties.has(p.difficulty));
      posts = posts.reverse();

      return `
        <header class="flex justify-between items-center p-6 bg-white border-b sticky top-0 z-10">
          <h1 class="text-2xl font-bold flex items-center gap-2">ğŸ”ï¸ å±±ä»²é–“å‹Ÿé›†</h1>
          <button onclick="currentView='create'; renderApp()" class="bg-[#0081c9] text-white px-4 py-2 rounded-lg font-bold shadow-md hover:bg-[#006ba6]">æ–°ã—ã„å‹Ÿé›†ã‚’ä½œæˆ</button>
        </header>

        <main class="px-6 py-4 flex-grow">
          <div class="bg-white rounded-xl p-6 mb-8 card-shadow border border-slate-100">
            <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">ğŸ” çµã‚Šè¾¼ã¿æ¡ä»¶</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <p class="text-xs font-bold text-slate-400 mb-2 uppercase">é›£æ˜“åº¦</p>
                <div class="flex flex-wrap gap-2">
                  ${['åˆå¿ƒè€…å‘ã‘', 'ä¸­ç´šè€…å‘ã‘', 'ä¸Šç´šè€…å‘ã‘'].map(d => {
                    const active = selectedDifficulties.has(d);
                    return `<span onclick="toggleDifficulty('${d}')" class="filter-chip" style="background:${active ? '#0284c7' : 'transparent'}; color:${active ? '#fff' : '#64748b'}; border-color:${active ? '#0284c7' : '#e2e8f0'}">${d}</span>`;
                  }).join('')}
                </div>
              </div>
              <div>
                <p class="text-xs font-bold text-slate-400 mb-2 uppercase">æ‰€åœ¨åœ°ï¼ˆåœ°åŸŸï¼‰</p>
                <select onchange="selectedPrefecture=this.value; renderApp()" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg outline-none">
                  <option value="ã™ã¹ã¦">ã™ã¹ã¦ã®åœ°åŸŸ</option>
                  ${PREFECTURES.map(p => `<option value="${p}" ${selectedPrefecture === p ? 'selected' : ''}>${p}</option>`).join('')}
                </select>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-10">
            ${posts.length === 0 ? '<p class="text-center text-slate-400 col-span-2 py-20 bg-white rounded-2xl">è©²å½“ã™ã‚‹å‹Ÿé›†ãŒã‚ã‚Šã¾ã›ã‚“</p>' : 
              posts.map(post => `
                <div class="bg-white rounded-2xl p-6 card-shadow cursor-pointer relative border border-transparent hover:border-blue-300 transition-all" onclick="openChat('${post.id}')">
                  <div class="absolute top-4 right-4 flex flex-col items-end gap-1">
                    <span class="bg-emerald-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">ğŸŸ¢ å‹Ÿé›†ä¸­</span>
                    <span class="bg-sky-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">${post.difficulty}</span>
                    <button onclick="deletePost(event, '${post.id}')" class="mt-2 text-slate-300 hover:text-red-500 text-xs flex items-center gap-1">ğŸ—‘ï¸ å‰Šé™¤</button>
                  </div>
                  <h3 class="text-xl font-bold mb-4 pr-16">${post.title}</h3>
                  <div class="space-y-2 text-sm text-slate-600 mb-4">
                    <p>â›°ï¸ <strong>${post.mountain} (${post.prefecture})</strong></p>
                    <p>ğŸ“… ç™»å±±: <span class="text-blue-600 font-bold">${formatDateTime(post.startDateTime)}</span></p>
                    <p>ğŸ ä¸‹å±±: <span class="text-slate-500">${formatDateTime(post.endDateTime)}</span></p>
                    <p>ğŸ‘¥ å‹Ÿé›†: ${post.members}</p>
                    <p>ğŸ”ï¸ æ¨™é«˜: ${post.elevation}m / ğŸ‘£ è·é›¢: ${post.distance}km</p>
                  </div>
                  <div class="pt-4 border-t flex justify-between items-center text-xs text-slate-400">
                    <span>æŠ•ç¨¿è€…: ${post.author}</span>
                    <span class="bg-blue-50 text-blue-600 px-3 py-1 rounded-full font-bold">ğŸ’¬ ${allData.filter(i => i.postId === post.id).length} ä»¶</span>
                  </div>
                </div>
              `).join('')}
          </div>
        </main>
      `;
    }

    function renderCreateView() {
      return `
        <div class="p-6">
          <h2 class="text-2xl font-bold mb-6 text-center">æ–°ã—ã„å‹Ÿé›†ã‚’ä½œæˆ</h2>
          <div class="bg-white rounded-2xl p-8 card-shadow border border-blue-50">
            <form id="createForm" class="space-y-5 text-sm">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block font-bold mb-1">ã‚ãªãŸã®åå‰</label>
                  <input type="text" id="author" required class="w-full p-3 bg-slate-50 border rounded-lg outline-none">
                </div>
                <div>
                  <label class="block font-bold mb-1 text-red-500">å‰Šé™¤ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                  <input type="password" id="password" required class="w-full p-3 bg-red-50 border border-red-100 rounded-lg outline-none">
                </div>
              </div>
              <div>
                <label class="block font-bold mb-1">å‹Ÿé›†ã‚¿ã‚¤ãƒˆãƒ«</label>
                <input type="text" id="title" required class="w-full p-3 bg-slate-50 border rounded-lg outline-none">
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block font-bold mb-1">å±±ã®åå‰</label>
                  <input type="text" id="mountain" required class="w-full p-3 bg-slate-50 border rounded-lg outline-none">
                </div>
                <div>
                  <label class="block font-bold mb-1">æ‰€åœ¨åœ°</label>
                  <select id="prefecture" class="w-full p-3 bg-slate-50 border rounded-lg outline-none">
                    ${PREFECTURES.map(p => `<option value="${p}">${p}</option>`).join('')}
                  </select>
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block font-bold mb-1 text-blue-600">ç™»å±±äºˆå®šæ—¥æ™‚</label>
                  <input type="datetime-local" id="startDateTime" required class="w-full p-3 bg-blue-50 border border-blue-100 rounded-lg outline-none">
                </div>
                <div>
                  <label class="block font-bold mb-1">ä¸‹å±±äºˆå®šæ—¥æ™‚</label>
                  <input type="datetime-local" id="endDateTime" required class="w-full p-3 bg-slate-50 border rounded-lg outline-none">
                </div>
              </div>
              <div>
                <label class="block font-bold mb-1">å‹Ÿé›†æœŸé™</label>
                <input type="date" id="deadline" required class="w-full p-3 bg-slate-50 border rounded-lg outline-none">
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block font-bold mb-1">é›£æ˜“åº¦</label>
                  <select id="difficulty" class="w-full p-3 bg-slate-50 border rounded-lg">
                    <option>åˆå¿ƒè€…å‘ã‘</option><option>ä¸­ç´šè€…å‘ã‘</option><option>ä¸Šç´šè€…å‘ã‘</option>
                  </select>
                </div>
                <div>
                  <label class="block font-bold mb-1">å‹Ÿé›†äººæ•°</label>
                  <select id="members" class="w-full p-3 bg-slate-50 border rounded-lg">
                    <option>1äºº</option><option>2äºº</option><option>3äººä»¥ä¸Š</option>
                  </select>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block font-bold mb-1">ä¸Šã‚Šæ¨™é«˜ (m)</label>
                  <input type="number" id="elevation" class="w-full p-3 bg-slate-50 border rounded-lg">
                </div>
                <div>
                  <label class="block font-bold mb-1">è·é›¢ (km)</label>
                  <input type="number" step="0.1" id="distance" class="w-full p-3 bg-slate-50 border rounded-lg">
                </div>
              </div>
              <div>
                <label class="block font-bold mb-1">è©³ç´°èª¬æ˜</label>
                <textarea id="description" rows="4" class="w-full p-3 bg-slate-50 border rounded-lg outline-none"></textarea>
              </div>
              <div class="space-y-3 pt-4">
                <button type="submit" class="w-full bg-[#0081c9] text-white py-4 rounded-xl font-bold shadow-lg">å‹Ÿé›†ã‚’æŠ•ç¨¿ã™ã‚‹</button>
                <button type="button" onclick="currentView='list'; renderApp()" class="w-full bg-slate-100 text-slate-600 py-3 rounded-xl font-bold border">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
              </div>
            </form>
          </div>
        </div>
      `;
    }

    function renderChatView() {
      const post = allData.find(i => i.id === currentPostId);
      const messages = allData.filter(i => i.postId === currentPostId && i.type === 'chat');
      return `
        <header class="p-6 flex items-center gap-4 bg-white card-shadow shrink-0 sticky top-0 z-10">
          <button onclick="currentView='list'; renderApp()" class="text-2xl p-2 hover:bg-slate-100 rounded-full transition-all">â†</button>
          <div class="overflow-hidden">
            <h2 class="font-bold truncate text-lg">${post.title}</h2>
            <p class="text-xs text-slate-500">ğŸ—» ${post.mountain} / ${formatDateTime(post.startDateTime)}</p>
          </div>
        </header>
        <div class="flex-grow p-6 overflow-y-auto space-y-4 scroll-container">
          <div class="bg-white p-5 rounded-2xl text-sm border border-blue-100 card-shadow">
            <p class="font-bold text-blue-600 mb-2">å‹Ÿé›†è©³ç´°</p>
            <p class="whitespace-pre-wrap leading-relaxed">${post.description || "è©³ç´°ãªã—"}</p>
          </div>
          ${messages.map(m => `
            <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 max-w-[90%]">
              <p class="text-[10px] text-slate-400 mb-1 font-bold">ğŸ‘¤ ${m.user}</p>
              <p class="text-sm">${m.text}</p>
            </div>
          `).join('')}
        </div>
        <div class="p-4 bg-white border-t flex gap-2 shrink-0">
          <input type="text" id="msgInput" class="flex-grow p-3 bg-slate-100 rounded-xl outline-none" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...">
          <button onclick="sendChat()" class="bg-[#0081c9] text-white px-6 rounded-xl font-bold">é€ä¿¡</button>
        </div>
      `;
    }

    // --- ãƒ­ã‚¸ãƒƒã‚¯ ---
    document.addEventListener('submit', (e) => {
      if (e.target.id === 'createForm') {
        e.preventDefault();
        const newPost = {
          type: 'post', id: 'p' + Date.now(),
          author: document.getElementById('author').value,
          password: document.getElementById('password').value,
          title: document.getElementById('title').value,
          mountain: document.getElementById('mountain').value,
          prefecture: document.getElementById('prefecture').value,
          startDateTime: document.getElementById('startDateTime').value,
          endDateTime: document.getElementById('endDateTime').value,
          deadline: document.getElementById('deadline').value,
          difficulty: document.getElementById('difficulty').value,
          members: document.getElementById('members').value,
          elevation: document.getElementById('elevation').value,
          distance: document.getElementById('distance').value,
          description: document.getElementById('description').value
        };
        allData.push(newPost);
        saveData();
        currentView = 'list';
      }
    });

    window.sendChat = () => {
      const input = document.getElementById('msgInput');
      if (!input.value) return;
      allData.push({ type: 'chat', postId: currentPostId, user: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼', text: input.value });
      input.value = '';
      saveData();
    };

    window.openChat = (id) => { currentPostId = id; currentView = 'chat'; renderApp(); };

    renderApp();
  </script>
 </body>
</html>
